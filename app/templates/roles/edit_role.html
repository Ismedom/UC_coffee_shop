{% extends "base_panel.html" %} {% block title %}Edit Role{% endblock %} {%
block content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-800">Edit Role</h1>
  <p class="text-gray-600 mt-2">Update role details and permissions</p>
</div>

<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
  <div class="flex items-center mb-6">
    <div
      class="flex-shrink-0 h-12 w-12 bg-indigo-100 rounded-full flex items-center justify-center mr-4"
    >
      <i class="fas fa-user-shield text-indigo-600 text-xl"></i>
    </div>
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Update Role</h2>
      <p class="text-gray-500 text-sm">ID: {{ role.id }}</p>
    </div>
  </div>

  <form method="POST" action="/roles/edit/{{ role.id }}" class="space-y-6">
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-1"
        >Role Name</label
      >
      <input
        type="text"
        name="name"
        id="name"
        value="{{ role.name }}"
        required
        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border"
      />
    </div>

    <div>
      <label
        for="description"
        class="block text-sm font-medium text-gray-700 mb-1"
        >Description</label
      >
      <textarea
        name="description"
        id="description"
        rows="3"
        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border"
      >
{{ role.description }}</textarea
      >
    </div>

    <div class="pt-4 border-t border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-key mr-2 text-purple-500"></i>
        Permissions
      </h3>
      <p class="text-gray-600 text-sm mb-4">
        Select the permissions to assign to this role
      </p>

      <div class="bg-gray-50 p-4 rounded-lg">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm text-gray-600"
            >{{ role_permissions|length }} of {{ all_permissions|length }}
            permissions granted</span
          >
          <div class="flex space-x-2">
            <button
              type="button"
              id="selectAll"
              class="text-xs text-indigo-600 hover:text-indigo-800"
            >
              Select All
            </button>
            <button
              type="button"
              id="deselectAll"
              class="text-xs text-gray-600 hover:text-gray-800"
            >
              Deselect All
            </button>
          </div>
        </div>

        <div class="space-y-4 p-4 border border-gray-200 rounded-lg bg-white">
          {% set resources = [] %} {% for perm in all_permissions %} {% if
          perm.resource not in resources %} {% set _ =
          resources.append(perm.resource) %} {% endif %} {% endfor %} {% for
          resource in resources | sort %}
          <div class="border-b border-gray-200 pb-3 last:border-b-0 last:pb-0">
            <h4 class="font-medium text-gray-800 mb-2 flex items-center">
              <i class="fas fa-folder mr-2 text-blue-500"></i>
              {{ resource | replace('_', ' ') | title }}
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 ml-6">
              {% for perm in all_permissions if perm.resource == resource %}
              <label
                class="flex items-start p-2 rounded hover:bg-gray-50 transition-colors duration-150"
              >
                <input
                  type="checkbox"
                  name="permissions"
                  value="{{ perm.id }}"
                  {%
                  if
                  perm.id
                  in
                  role_permissions
                  %}checked{%
                  endif
                  %}
                  class="mt-1 form-checkbox h-4 w-4 text-indigo-600"
                />
                <span class="ml-2 text-gray-700">
                  <span class="block text-sm font-medium">
                    {{ perm.action | title }}
                    <span class="text-xs text-gray-500 font-normal"
                      >({{ perm.name }})</span
                    >
                  </span>
                  {% if perm.description %}
                  <span class="block text-xs text-gray-500 mt-1"
                    >{{ perm.description }}</span
                  >
                  {% endif %}
                </span>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between pt-4">
      <div>
        <button
          type="submit"
          class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200 flex items-center"
        >
          <i class="fas fa-save mr-2"></i>
          Update Role
        </button>
      </div>
      <div>
        <a
          href="/roles"
          class="text-gray-600 hover:text-gray-800 hover:underline flex items-center"
        >
          <i class="fas fa-times mr-2"></i>
          Cancel
        </a>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("selectAll").addEventListener("click", function () {
      const checkboxes = document.querySelectorAll('input[name="permissions"]');
      checkboxes.forEach((checkbox) => {
        checkbox.checked = true;
      });
      updatePermissionCount();
    });

    document
      .getElementById("deselectAll")
      .addEventListener("click", function () {
        const checkboxes = document.querySelectorAll(
          'input[name="permissions"]'
        );
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });
        updatePermissionCount();
      });

    const permissionCheckboxes = document.querySelectorAll(
      'input[name="permissions"]'
    );
    const permissionCount = document.querySelector(".text-sm.text-gray-600");

    function updatePermissionCount() {
      const selectedCount = document.querySelectorAll(
        'input[name="permissions"]:checked'
      ).length;
      const totalCount = permissionCheckboxes.length;
      permissionCount.textContent = `${selectedCount} of ${totalCount} permissions granted`;
    }

    permissionCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updatePermissionCount);
    });

    document.querySelectorAll(".resource-header").forEach((header) => {
      header.addEventListener("click", function () {
        const resource = this.dataset.resource;
        const checkboxes = document.querySelectorAll(
          `input[name="permissions"][data-resource="${resource}"]`
        );
        const allChecked = Array.from(checkboxes).every(
          (checkbox) => checkbox.checked
        );

        checkboxes.forEach((checkbox) => {
          checkbox.checked = !allChecked;
        });

        updatePermissionCount();
      });
    });
  });
</script>

<style>
  .resource-header {
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .resource-header:hover {
    background-color: #f9fafb;
  }
</style>
{% endblock %}
