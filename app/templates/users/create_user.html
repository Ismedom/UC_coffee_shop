{% extends "base_panel.html" %} {% block title %}Add User{% endblock %} {% block
content %}
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-800">Add New User</h1>
  <p class="text-gray-600 mt-2">
    Create a new user account with specific roles and permissions
  </p>
</div>

<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
  <div class="flex items-center mb-6">
    <div
      class="flex-shrink-0 h-12 w-12 bg-green-100 rounded-full flex items-center justify-center mr-4"
    >
      <i class="fas fa-user-plus text-green-600 text-xl"></i>
    </div>
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Create New User</h2>
      <p class="text-gray-500 text-sm">Fill in all required information</p>
    </div>
  </div>

  <form method="POST" action="/users/create" class="space-y-6">
    <div>
      <label for="username" class="block text-sm font-medium text-gray-700 mb-1"
        >Username <span class="text-red-500">*</span></label
      >
      <input
        type="text"
        name="username"
        id="username"
        required
        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border"
        placeholder="Enter username"
      />
      <p class="text-xs text-gray-500 mt-1">
        3-20 characters, letters, numbers and underscores only
      </p>
    </div>

    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-1"
        >Email <span class="text-red-500">*</span></label
      >
      <input
        type="email"
        name="email"
        id="email"
        required
        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border"
        placeholder="Enter user email"
      />
      <p class="text-xs text-gray-500 mt-1">
        A valid email address for communication
      </p>
    </div>

    <div>
      <label for="password" class="block text-sm font-medium text-gray-700 mb-1"
        >Password <span class="text-red-500">*</span></label
      >
      <div class="relative">
        <input
          type="password"
          name="password"
          id="password"
          required
          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 border"
          placeholder="Enter password"
        />
        <button
          type="button"
          id="togglePassword"
          class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
          style="top: 1.75rem"
        >
          <i class="fas fa-eye absolute right-3 -top-3"></i>
        </button>
      </div>
      <div class="mt-2">
        <div class="flex items-center mb-1">
          <div
            id="strength-meter"
            class="h-1 w-full bg-gray-200 rounded-full mr-2"
          >
            <div
              id="strength-meter-fill"
              class="h-1 rounded-full transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>
          <span id="strength-text" class="text-xs text-gray-500">Weak</span>
        </div>
        <ul class="text-xs text-gray-500 space-y-1">
          <li id="length-requirement" class="flex items-center">
            <i
              class="fas fa-times text-red-500 mr-1"
              style="font-size: 10px"
            ></i>
            At least 8 characters
          </li>
          <li id="number-requirement" class="flex items-center">
            <i
              class="fas fa-times text-red-500 mr-1"
              style="font-size: 10px"
            ></i>
            Contains a number
          </li>
          <li id="letter-requirement" class="flex items-center">
            <i
              class="fas fa-times text-red-500 mr-1"
              style="font-size: 10px"
            ></i>
            Contains a letter
          </li>
        </ul>
      </div>
    </div>

    <div class="pt-4 border-t border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-user-shield mr-2 text-purple-500"></i>
        Assign Roles
      </h3>
      <p class="text-gray-600 text-sm mb-4">
        Select roles to assign to this user
      </p>

      <div class="bg-gray-50 p-4 rounded-lg">
        <div class="flex items-center justify-between mb-4">
          <span id="roles-count" class="text-sm text-gray-600"
            >0 of {{ roles | length }} roles selected</span
          >
          <div class="flex space-x-2">
            <button
              type="button"
              id="selectAllRoles"
              class="text-xs text-indigo-600 hover:text-indigo-800"
            >
              Select All
            </button>
            <button
              type="button"
              id="deselectAllRoles"
              class="text-xs text-gray-600 hover:text-gray-800"
            >
              Deselect All
            </button>
          </div>
        </div>

        <div
          class="space-y-2 grid grid-cols-2 p-2 border border-gray-200 rounded-lg bg-white"
        >
          {% for role in roles %}
          <label
            class="flex items-start p-2 rounded hover:bg-gray-50 transition-colors duration-150"
          >
            <input
              type="checkbox"
              name="roles"
              value="{{ role.id }}"
              class="mt-1 form-checkbox h-4 w-4 text-indigo-600"
            />
            <span class="ml-2 text-gray-700">
              <span class="block text-sm font-medium">{{ role.name }}</span>
              {% if role.description %}
              <span class="block text-xs text-gray-500 mt-1"
                >{{ role.description }}</span
              >
              {% endif %}
            </span>
          </label>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="pt-4 border-t border-gray-200">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-toggle-on mr-2 text-green-500"></i>
        Account Status
      </h3>
      <div class="flex items-center">
        <label class="inline-flex items-center">
          <input
            type="checkbox"
            name="is_active"
            value="true"
            checked
            class="form-checkbox h-5 w-5 text-indigo-600"
          />
          <span class="ml-2 text-gray-700">Activate account immediately</span>
        </label>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        If unchecked, the user will need to be activated before they can log in
      </p>
    </div>

    <div class="flex items-center justify-between pt-4">
      <div>
        <button
          type="submit"
          id="submit-button"
          class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors duration-200 flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <i class="fas fa-user-plus mr-2"></i>
          Create User
        </button>
      </div>
      <div>
        <a
          href="/users"
          class="text-gray-600 hover:text-gray-800 hover:underline flex items-center"
        >
          <i class="fas fa-times mr-2"></i>
          Cancel
        </a>
      </div>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const togglePassword = document.getElementById("togglePassword");
    const passwordField = document.getElementById("password");

    if (togglePassword && passwordField) {
      togglePassword.addEventListener("click", function () {
        const type =
          passwordField.getAttribute("type") === "password"
            ? "text"
            : "password";
        passwordField.setAttribute("type", type);

        const icon = togglePassword.querySelector("i");
        if (type === "password") {
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        } else {
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        }
      });
    }

    const passwordInput = document.getElementById("password");
    const strengthMeterFill = document.getElementById("strength-meter-fill");
    const strengthText = document.getElementById("strength-text");
    const lengthRequirement = document.getElementById("length-requirement");
    const numberRequirement = document.getElementById("number-requirement");
    const letterRequirement = document.getElementById("letter-requirement");
    const submitButton = document.getElementById("submit-button");

    function checkPasswordStrength(password) {
      let strength = 0;

      const hasLength = password.length >= 8;
      if (hasLength) strength += 33;
      updateRequirementIcon(lengthRequirement, hasLength);

      const hasNumber = /\d/.test(password);
      if (hasNumber) strength += 33;
      updateRequirementIcon(numberRequirement, hasNumber);

      const hasLetter = /[a-zA-Z]/.test(password);
      if (hasLetter) strength += 34;
      updateRequirementIcon(letterRequirement, hasLetter);

      strengthMeterFill.style.width = `${strength}%`;

      if (strength === 0) {
        strengthText.textContent = "Weak";
        strengthText.className = "text-xs text-red-500";
        strengthMeterFill.className =
          "h-1 rounded-full transition-all duration-300 bg-red-500";
      } else if (strength < 66) {
        strengthText.textContent = "Medium";
        strengthText.className = "text-xs text-yellow-500";
        strengthMeterFill.className =
          "h-1 rounded-full transition-all duration-300 bg-yellow-500";
      } else {
        strengthText.textContent = "Strong";
        strengthText.className = "text-xs text-green-500";
        strengthMeterFill.className =
          "h-1 rounded-full transition-all duration-300 bg-green-500";
      }

      submitButton.disabled = !(hasLength && hasNumber && hasLetter);
    }

    function updateRequirementIcon(element, isValid) {
      const icon = element.querySelector("i");
      if (isValid) {
        icon.classList.remove("fa-times", "text-red-500");
        icon.classList.add("fa-check", "text-green-500");
      } else {
        icon.classList.remove("fa-check", "text-green-500");
        icon.classList.add("fa-times", "text-red-500");
      }
    }

    if (passwordInput) {
      passwordInput.addEventListener("input", function () {
        checkPasswordStrength(this.value);
      });
    }

    document
      .getElementById("selectAllRoles")
      .addEventListener("click", function () {
        const checkboxes = document.querySelectorAll('input[name="roles"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = true;
        });
        updateRolesCount();
      });

    document
      .getElementById("deselectAllRoles")
      .addEventListener("click", function () {
        const checkboxes = document.querySelectorAll('input[name="roles"]');
        checkboxes.forEach((checkbox) => {
          checkbox.checked = false;
        });
        updateRolesCount();
      });

    const roleCheckboxes = document.querySelectorAll('input[name="roles"]');
    function updateRolesCount() {
      const selectedCount = document.querySelectorAll(
        'input[name="roles"]:checked'
      ).length;
      const totalCount = roleCheckboxes.length;
      document.getElementById(
        "roles-count"
      ).textContent = `${selectedCount} of ${totalCount} roles selected`;
    }

    roleCheckboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", updateRolesCount);
    });

    updateRolesCount();
  });
</script>
{% endblock %}
